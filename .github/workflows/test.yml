name: Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4

      - name: Select latest Xcode
        run: sudo xcode-select -s "$(ls -d /Applications/Xcode*.app | sort -V | tail -1)/Contents/Developer"

      - name: Show build environment
        run: |
          xcodebuild -version
          xcrun simctl list devices available | grep iPhone | tail -5

      - name: Run tests (iOS Simulator)
        run: |
          DEVICE=$(xcrun simctl list devices available -j | python3 -c "
          import json, sys
          data = json.load(sys.stdin)
          best = None
          for runtime, devices in data['devices'].items():
              if 'iOS' not in runtime:
                  continue
              for d in devices:
                  if d['isAvailable'] and 'iPhone' in d['name']:
                      best = d['name']
          print(best)
          ")
          echo "Using simulator: $DEVICE"
          xcodebuild test \
            -project OpenPulse.xcodeproj \
            -scheme OpenPulse \
            -destination "platform=iOS Simulator,name=$DEVICE" \
            -resultBundlePath TestResults \
            CODE_SIGNING_ALLOWED=NO | xcpretty || exit 1

      - name: Upload test results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: TestResults
          path: TestResults
